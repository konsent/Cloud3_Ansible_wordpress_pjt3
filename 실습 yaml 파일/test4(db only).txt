# DB
- name: DB setting
  hosts: ansi-node2
  gather_facts: yes
  tags: db
  vars:
    pkg_list:
    - python3-pymysql
    - mysql-server
    - mysql-client
  tasks:
  - name: Update
    apt:
      upgrade: yes

  - name: Install Pkgs
    apt:
      name: "{{ pkg_list }}"
      update_cache: yes
      cache_valid_time: 3600
      state: latest

  - name: Start Mysql
    service:
      name: mysql
      state: started
      enabled: yes

  - mysql_user:
      name: root
      password: "dkaghdkagh1."
      priv: "*.*:ALL,GRANT"
      host: 'localhost'
      login_unix_socket: /var/run/mysqld/mysqld.sock
      state: present
      login_user: root
      login_password: "dkaghdkagh1."

  - template:
      src: root_cnf.j2
      dest: /root/.my.cnf
      owner: root
      mode: '0600'

  - lineinfile:
      path: /etc/mysql/mysql.conf.d/mysqld.cnf
      regexp: '^bind-address'
      line: 'bind-address = 0.0.0.0'
      backup: yes
    notify:
      - Restart mysql

  - name: Deletes anonymous MySQL server user for ansible_fqdn
    mysql_user:
      user: ''
      host: "{{ ansible_fqdn }}"
      state: absent

  - name: Deletes anonymous MySQL server user for localhost
    mysql_user:
      user: ''
      host: "localhost"
      state: absent

  - name: Secures the MySQL root user for IPV6 localhost (::1)
    mysql_user:
      user: root
      password: "dkaghdkagh1."
      host: "::1"
    no_log: yes

  - name: Secures the MySQL root user for IPV4 localhost (127.0.0.1)
    mysql_user:
      user: root
      password: "dkaghdkagh1."
      host: "127.0.0.1"
    no_log: yes

  - name: Secures the MySQL root user for localhost domain (localhost)
    mysql_user:
      user: root
      password: "dkaghdkagh1."
      host: "localhost"
    no_log: yes

  - name: Secures the MySQL root user for server_hostname domain
    mysql_user:
      user: root
      password: "dkaghdkagh1."
      host: "{{ ansible_fqdn }}"
    no_log: yes

  - name: Remove the MySQL test database
    mysql_db:
      name: test
      state: absent
      login_user: root
      login_password: "dkaghdkagh1."

  - name: Creates database for Guestbook
    mysql_db:
      name: "wordpress"
      state: present
      login_user: root
      login_password: "dkaghdkagh1."

  - name: Create MySQL user for Guestbook
    mysql_user:
      name: "admin"
      password: "dkaghdkagh1."

  - name: Open firewall
    ufw:
      port: "3306"
      proto: tcp
      rule: allow

 handlers:
    - name: Restart mysql
      service:
        name: mysql
        state: restarted