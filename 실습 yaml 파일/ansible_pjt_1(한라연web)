- name: Set web server
  hosts: webserver
  gather_facts: no
  become: yes
  tags: web
  tasks:
  - name: Install apache2 and mysql packages
    apt:
      name: "{{ apache2_mysql_pkg_list }}"
      update_cache: yes
      cache_valid_time: 3600
      state: latest

  - name: Allow port on http
    ufw:
      rule: allow
      port: "{{ http_port }}"

  - name: Update apt
    apt:
      name: aptitude
      update_cache: yes
      state: latest
      force_apt_get: yes

  - name: Install software-properties-common
    apt:
      name: software-properties-common
      state: latest

  - name: Add php reppsitory
    apt_repository:
      repo: 'ppa:ondrej/php'

  - name: Update repository
    apt:
      update_cache: yes

  - name: Install php7.4
    apt:
      name: php7.4
      state: present

  - name: Install lamp stack
    apt:
      name: "{{ php_pkg_list }}"
      state: present
      update_cache: yes

  - name: Restart apache2 service
    service:
      name: apache2
      state: restarted

  - name: Download wordpress source
    get_url:
      url: https://wordpress.org/latest.tar.gz
      dest: /tmp/wordpress.tar.gz

  - name: Unarchive wordpress source
    unarchive:
      src: /tmp/wordpress.tar.gz
      dest: /var/www/html
      remote_src: true

  - name: Set wordpress database configuration
    block:
    - name: Create wp-confg.php
      copy:
        src: /var/www/html/wordpress/wp-config-sample.php
        dest: /var/www/html/wordpress/wp-config.php
        owner: apache2
        group: www-data
        remote_src: yes

    - name: Set configuration for db name
      replace:
	path: /var/www/html/wordpress/wp-config.php
        regexp: database_name_here
        replace: wordpress

    - name: Set congiguration for db user
      replace:
        path: /var/www/html/wordpress/wp-config.php
        regexp: username_here
        replace: admin

    - name: Set congiguration for db password
      replace:
        path: /var/www/html/wordpress/wp-config.php
        regexp: password_here
        replace: dkaghdkagh1.

    - name: Set configuration for db host
      replace:
        path: /var/www/html/wordpress/wp-config.php
        regexp: localhost
        replace: 192.168.56.22